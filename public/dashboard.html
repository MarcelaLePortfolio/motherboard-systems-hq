<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Motherboard HQ — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0e0e10;
      --card: #151518;
      --ink: #e8e8ea;
      --muted: #9aa0a6;
      --accent: #f0a35b;
      --assistant: #1c1c22;
      --user: #1a2a1a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      background: var(--bg); color: var(--ink);
      font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    header {
      padding: 12px 16px; background: var(--card);
      position: sticky; top: 0; z-index: 10;
      border-bottom: 1px solid #22242a;
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .panel {
      background: var(--card); border: 1px solid #23252c; border-radius: 12px;
      display: flex; flex-direction: column; min-height: 65vh;
    }
    .feed {
      padding: 16px; overflow-y: auto; flex: 1; scroll-behavior: smooth;
    }
    .row { display: flex; margin: 10px 0; gap: 10px; align-items: flex-start; }
    .row.user { justify-content: flex-end; }
    .bubble {
      max-width: 80%;
      padding: 10px 12px; border-radius: 12px;
      border: 1px solid #2a2c33; white-space: pre-wrap; word-wrap: break-word;
    }
    .bubble.assistant { background: var(--assistant); }
    .bubble.user { background: var(--user); }
    .meta { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .inputbar {
      padding: 10px; border-top: 1px solid #23252c; display: flex; gap: 8px;
    }
    .inputbar input[type="text"] {
      flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #2a2c33; background: #0f0f12; color: var(--ink);
    }
    .inputbar button {
      padding: 12px 16px; border-radius: 10px; border: 1px solid #2a2c33;
      background: var(--accent); color: #20150b; font-weight: 700; cursor: pointer;
    }
    .loader { display: inline-block; animation: pulse 1.2s infinite ease-in-out; }
    @keyframes pulse { 0% {opacity: .4} 50% {opacity: 1} 100% {opacity: .4} }
    @media (max-width: 640px) {
      .bubble { max-width: 90%; }
      .panel { min-height: 70vh; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <strong>Motherboard Systems HQ</strong>
      <span class="meta"> · Matilda (local) · Ollama</span>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div id="chat-feed" class="feed" aria-live="polite" aria-label="Chat feed">
        <div class="row">
          <div class="bubble assistant">
            Hi! I’m Matilda. I’m wired to your local Ollama brain and can delegate file/automation tasks to Cade.
            Tell me what you need, and I’ll take it from here.
          </div>
        </div>
      </div>
      <form id="chat-form" class="inputbar" onsubmit="sendMessage(event)">
        <input id="chat-input" type="text" autocomplete="off" placeholder="Type a message for Matilda…" />
        <button type="submit" id="send-btn">Send</button>
      </form>
    </section>
  </main>

  <script>
    (function () {
      const feed = document.getElementById('chat-feed');
      const input = document.getElementById('chat-input');
      const form  = document.getElementById('chat-form');
      const sendBtn = document.getElementById('send-btn');

      function addMessage(role, text) {
        const row = document.createElement('div');
        row.className = 'row ' + (role === 'user' ? 'user' : 'assistant');
        const bubble = document.createElement('div');
        bubble.className = 'bubble ' + (role === 'user' ? 'user' : 'assistant');
        bubble.textContent = text;
        row.appendChild(bubble);
        feed.appendChild(row);
        feed.scrollTop = feed.scrollHeight;
        return bubble;
      }

      async function postMatilda(message) {
        const r = await fetch('/matilda', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        if (!r.ok) {
          const text = await r.text().catch(() => '');
          throw new Error(text || ('HTTP ' + r.status));
        }
        return r.json();
      }

      window.sendMessage = async function (e) {
        if (e) e.preventDefault();
        const text = (input.value || '').trim();
        if (!text) return;
        input.value = '';
        input.disabled = true; sendBtn.disabled = true;

        addMessage('user', text);
        const loaderRow = document.createElement('div');
        loaderRow.className = 'row';
        const loaderBubble = document.createElement('div');
        loaderBubble.className = 'bubble assistant loader';
        loaderBubble.textContent = 'Thinking…';
        loaderRow.appendChild(loaderBubble);
        feed.appendChild(loaderRow);
        feed.scrollTop = feed.scrollHeight;

        try {
          const data = await postMatilda(text);
          loaderBubble.remove();
          const replies = Array.isArray(data?.replies) ? data.replies : [String(data?.reply || '')];
          for (const chunk of replies) {
            if (!chunk) continue;
            addMessage('assistant', chunk);
          }
        } catch (err) {
          loaderBubble.remove();
          addMessage('assistant', '⚠️ Error: ' + (err?.message || String(err)));
        } finally {
          input.disabled = false; sendBtn.disabled = false; input.focus();
        }
      };

      form.addEventListener('submit', sendMessage);
    })();
  </script>
</body>
</html>
