<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Motherboard HQ — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { background:#0e0e10; color:#e8e8ea; font:15px system-ui; margin:0; }
    .panel { background:#151518; border-radius:12px; border:1px solid #23252c; min-height:70vh; display:flex; flex-direction:column; }
    .feed { flex:1; overflow-y:auto; padding:16px; }
    .row { margin:8px 0; display:flex; }
    .row.user { justify-content:flex-end; }
    .bubble { padding:10px 12px; border-radius:12px; max-width:75%; white-space:pre-wrap; }
    .bubble.user { background:#1a2a1a; }
    .bubble.assistant { background:#1c1c22; }
    .inputbar { display:flex; gap:8px; border-top:1px solid #23252c; padding:10px; }
    .inputbar input { flex:1; padding:10px; border-radius:8px; border:1px solid #2a2c33; background:#0f0f12; color:#fff; }
    .inputbar button { background:#f0a35b; border:none; border-radius:8px; padding:10px 16px; cursor:pointer; }
  </style>
</head>
<body>
  <main class="panel">
    <div id="chat-feed" class="feed">
      <div class="row"><div class="bubble assistant">
        Hi! I’m Matilda. I’m wired to your local Ollama brain. Type something below!
      </div></div>
    </div>
    <form id="chat-form" class="inputbar">
      <input id="chat-input" type="text" placeholder="Type a message…" />
      <button type="submit">Send</button>
    </form>
  </main>

  <script>
    const feed = document.getElementById('chat-feed');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('chat-input');

    function addMessage(role, text) {
      const row = document.createElement('div');
      row.className = 'row ' + role;
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + role;
      bubble.textContent = text;
      row.appendChild(bubble);
      feed.appendChild(row);
      feed.scrollTop = feed.scrollHeight;
    }

    async function postMatilda(message) {
      try {
        const res = await fetch('/matilda', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        const text = await res.text();
        console.log("Raw response:", text);
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          data = { replies: [text] };
        }
        return data;
      } catch (err) {
        return { replies: ['⚠️ Network error: ' + (err.message || String(err))] };
      }
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      addMessage('user', text);
      addMessage('assistant', '…');

      const data = await postMatilda(text);
      const bubbles = feed.querySelectorAll('.bubble.assistant');
      const last = bubbles[bubbles.length - 1];
      last.textContent = (data?.replies && data.replies.length)
        ? data.replies.join("\\n")
        : JSON.stringify(data);
    });
  </script>
</body>
</html>
