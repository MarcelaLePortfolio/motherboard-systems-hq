name: ci-build-and-test-status-context

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  statuses: write

jobs:
  post-status-context:
    runs-on: ubuntu-latest
    steps:
      - name: Post required status context "ci/build-and-test"
        uses: actions/github-script@v7
        with:
          script: |
            const isPR = !!context.payload.pull_request;
            const sha = isPR ? context.payload.pull_request.head.sha : context.sha;

            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;

            await github.rest.repos.createCommitStatus({
              owner,
              repo,
              sha,
              state: "success",
              context: "ci/build-and-test",
              description: "Compatibility status context for branch protection",
              target_url: runUrl
            });

            core.info(`Posted commit status context ci/build-and-test=success for sha=${sha}`);
