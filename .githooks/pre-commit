#!/usr/bin/env bash
set -euo pipefail

fail() { echo "❌ pre-commit: $*" >&2; exit 1; }
warn() { echo "⚠️  pre-commit: $*" >&2; }

TARGET="public/dashboard.html"

is_staged() { git diff --cached --name-only | grep -qx "$1"; }

# Block committing backup files
if git diff --cached --name-only | grep -qE "^public/dashboard\\.html\\.bak-"; then
  fail "Refusing commit: do not commit dashboard.html.bak-* files."
fi

# Only enforce if dashboard.html is staged
if ! is_staged "$TARGET"; then
  exit 0
fi

tmp="$(mktemp)"
trap "rm -f \"$tmp\"" EXIT

git show ":$TARGET" > "$tmp" 2>/dev/null || fail "Could not read staged $TARGET"

lines="$(wc -l < "$tmp" | tr -d " ")"
[[ "$lines" -ge 150 ]] || fail "$TARGET staged is only ${lines} lines (collapsed)."

grep -qi "<!doctype html" "$tmp" || fail "Missing <!DOCTYPE html>."
grep -qi "<html" "$tmp"          || fail "Missing <html> tag."
grep -qi "</body>" "$tmp"        || fail "Missing </body>."
grep -qi "</html>" "$tmp"        || fail "Missing </html>."

echo "✅ pre-commit: dashboard.html guardrails passed."
