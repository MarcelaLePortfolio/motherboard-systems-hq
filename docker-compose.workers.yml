services:
  workerA:
    build:
      context: .
      dockerfile: Dockerfile.worker
    image: motherboard_systems_hq-worker:node20
    volumes:
      - ./server/worker:/app/server/worker:ro
    command: ["node","server/worker/phase26_task_worker.mjs"]
    networks:
      - mbhq_default
    environment:
      POSTGRES_URL: postgres://postgres:postgres@postgres:5432/postgres
      WORKER_OWNER: ${WORKER_OWNER_A:-docker-wA}

      # Enable lease-mode so claim_one gets (run_id, owner, lease_ms) and matches PG SQL arity.
      PHASE34_ENABLE_LEASE: "1"
      PHASE34_LEASE_MS: ${PHASE34_LEASE_MS:-5000}

      # Phase34: heartbeat + reclaim
      PHASE34_HEARTBEAT_PG_SQL: "server/worker/phase34_heartbeat_pg.sql"
      PHASE34_RECLAIM_PG_SQL: "server/worker/phase34_reclaim_stale_pg.sql"

      # IMPORTANT: override PHASE32_* (worker prefers these)
      PHASE32_CLAIM_ONE_SQL: "sql/phase40_claim_one_tierA.sql"
      PHASE32_MARK_SUCCESS_SQL: "server/worker/phase34_mark_success_pg.sql"
      PHASE32_MARK_FAILURE_SQL: "server/worker/phase34_mark_failure_pg.sql"

      # Also wire legacy Phase27 keys (belt & suspenders)
      PHASE27_CLAIM_ONE_SQL: "sql/phase40_claim_one_tierA.sql"
      PHASE27_MARK_SUCCESS_SQL: "server/worker/phase34_mark_success_pg.sql"
      PHASE27_MARK_FAILURE_SQL: "server/worker/phase34_mark_failure_pg.sql"

      PHASE26_TICK_MS: ${PHASE26_TICK_MS:-500}
      WORKER_BACKOFF_BASE_MS: ${WORKER_BACKOFF_BASE_MS:-2000}

  workerB:
    build:
      context: .
      dockerfile: Dockerfile.worker
    image: motherboard_systems_hq-worker:node20
    volumes:
      - ./server/worker:/app/server/worker:ro
    command: ["node","server/worker/phase26_task_worker.mjs"]
    networks:
      - mbhq_default
    environment:
      POSTGRES_URL: postgres://postgres:postgres@postgres:5432/postgres
      WORKER_OWNER: ${WORKER_OWNER_B:-docker-wB}

      PHASE34_ENABLE_LEASE: "1"
      PHASE34_LEASE_MS: ${PHASE34_LEASE_MS:-5000}

      PHASE34_HEARTBEAT_PG_SQL: "server/worker/phase34_heartbeat_pg.sql"
      PHASE34_RECLAIM_PG_SQL: "server/worker/phase34_reclaim_stale_pg.sql"

      PHASE32_CLAIM_ONE_SQL: "sql/phase40_claim_one_tierA.sql"
      PHASE32_MARK_SUCCESS_SQL: "server/worker/phase34_mark_success_pg.sql"
      PHASE32_MARK_FAILURE_SQL: "server/worker/phase34_mark_failure_pg.sql"

      PHASE27_CLAIM_ONE_SQL: "sql/phase40_claim_one_tierA.sql"
      PHASE27_MARK_SUCCESS_SQL: "server/worker/phase34_mark_success_pg.sql"
      PHASE27_MARK_FAILURE_SQL: "server/worker/phase34_mark_failure_pg.sql"

      PHASE26_TICK_MS: ${PHASE26_TICK_MS:-500}
      WORKER_BACKOFF_BASE_MS: ${WORKER_BACKOFF_BASE_MS:-2000}

networks:
  mbhq_default:
    external: true
    name: motherboard_systems_hq_default
