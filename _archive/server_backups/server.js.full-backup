app.post("/tasks/delegate", (req, res) => { console.log("ğŸ“¥ Delegate POST received:", req.body); res.json({ status: "ok", taskId: req.body.taskId }); });
fs.appendFileSync(path.join(__dirname, "ui/dashboard/ticker-events.log"), JSON.stringify({ timestamp: Math.floor(Date.now()/1000), agent: "matilda", event: `chat: ${userMessage} -> ${reply}` }));
app.use(bodyParser.json());

app.use(express.json());
app.use(express.static(path.join(__dirname, "ui/dashboard")));
app.use(express.static(path.join(__dirname, "public")));

// --- 1ï¸âƒ£ Agent Status via PM2 ---
app.get("/api/agent-status", (req, res) => {
  exec("pm2 jlist", (err, stdout) => {
    if (err) {
      return res.json({
        Matilda: { status: "offline" }
        Cade: { status: "offline" }
        Effie: { status: "offline" }
      });

    try {
      const list = JSON.parse(stdout);
      const statusMap = { Matilda: { status: "offline" }, Cade: { status: "offline" }, Effie: { status: "offline" } };
      list.forEach(proc => {
        const name = proc.name.toLowerCase();
        const online = proc.pm2_env.status === "online";
        if (name.includes("matilda")) statusMap.Matilda.status = online ? "online" : "offline";
        if (name.includes("cade")) statusMap.Cade.status = online ? "online" : "offline";
        if (name.includes("effie")) statusMap.Effie.status = online ? "online" : "offline";
      });
      res.json(statusMap);
        Cade: { status: "offline" }
        Effie: { status: "offline" }
      });
  });
});

// --- 2ï¸âƒ£ Chat Endpoint: Send input to Ollama ---
app.post("/api/chat", async (req, res) => {
  const userMessage = req.body.message || "";
  if (!userMessage.trim()) return res.json({ reply: "..." });

  try {
    const response = await fetch("http://127.0.0.1:11434/api/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" }
      body: JSON.stringify({ model: "llama3:8b", prompt: userMessage, stream: false })
    });

    const data = await response.json();
    const reply = data.response || "(no response)";

    res.json({ reply });
});

// --- 3ï¸âƒ£ Ops Stream & Project Tracker Endpoints (Unchanged) ---
app.get("/api/ops-stream", (req, res) => {
  const logFile = path.join(__dirname, "ui/dashboard/ticker-events.log");
  if (!fs.existsSync(logFile)) return res.json([]);
  const events = logs.slice(-20).map(line => {
    try {
      const obj = JSON.parse(line);
      return { message: `${obj.agent} | ${obj.event}` };
  res.json(events);
});

app.listen(PORT, () => console.log(`âœ… Dashboard live on port ${PORT}`));

// --- 4ï¸âƒ£ Chat Endpoint for Matilda ---

// Middleware to parse JSON bodies
app.use(bodyParser.json());

app.post("/api/chat", async (req, res) => {
  const userMessage = req.body?.message || "";
  console.log("ğŸ“© Chat received:", userMessage);

  try {
} catch (err) { console.error("âŒ Error:", err); }    // Call local Ollama server
    const ollamaRes = await fetch("http://127.0.0.1:11434/api/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" }
        prompt: userMessage,
        stream: false
      })

    const ollamaData = await ollamaRes.json();
    const reply = ollamaData.response || "(no response)";
    console.log("ğŸ¤– Matilda reply:", reply);

    // Return reply to dashboard
    res.json({ reply });

    // Optional: Log chat to ticker-events.log for auditing
    console.error("âŒ Chat error:", err);
    res.status(500).json({ reply: "(error)" });
});
});
  console.log("ğŸ“¥ Delegate POST received:", req.body);
  res.json({ status: "ok", taskId: req.body.taskId });
});
  console.log("ğŸ“¥ Delegate POST received:", req.body);
  res.json({ status: "ok", taskId: req.body.taskId });
});
} catch (err) { console.error("âŒ Error:", err); }  console.log("ğŸ“¥ Delegate POST received:", req.body);
  res.json({ status: "ok", taskId: req.body.taskId });
});
  console.log("ğŸ“¥ Delegate POST received:", req.body);
  res.json({ status: "ok", taskId: req.body.taskId });
});
  console.log("ğŸ“¥ Delegate POST received:", req.body);
  res.json({ status: "ok", taskId: req.body.taskId });
});
  console.log("ğŸ“¥ Delegate POST received:", req.body);
  res.json({ status: "ok", taskId: req.body.taskId });
});
  console.log("ğŸ“¥ Delegate POST received:", req.body);
  res.json({ status: "ok", taskId: req.body.taskId });
});
  console.log("ğŸ“¥ Delegate POST received:", req.body);
  res.json({ status: "ok", taskId: req.body.taskId });
});
  console.log("ğŸ“¥ Delegate POST received:", req.body);
  res.json({ status: "ok", taskId: req.body.taskId });
});
} catch (err) { console.error("âŒ Error:", err); }  console.log("ğŸ“¥ Delegate POST received:", req.body);
  res.json({ status: "ok", taskId: req.body.taskId });
});
  console.log("ğŸ“¥ Delegate POST received:", req.body);
  res.json({ status: "ok", taskId: req.body.taskId });
});
  console.log("ğŸ“¥ Delegate POST received:", req.body);
  res.json({ status: "ok", taskId: req.body.taskId });
});
  console.log("ğŸ“¥ Delegate POST received:", req.body);
  res.json({ status: "ok", taskId: req.body.taskId });
});
