import express from "express";
import bodyParser from "body-parser";
import fs from "fs";
import path from "path";
import { exec } from "child_process";

const app = express();

// --- 1ï¸âƒ£ Status Map ---
const statusMap = {
  Matilda: { status: "offline" },
  Cade: { status: "offline" },
  Effie: { status: "offline" }
};

// --- 2ï¸âƒ£ Body Parser ---
app.use(bodyParser.json());

// --- 3ï¸âƒ£ Delegate Endpoint ---
app.post("/tasks/delegate", (req, res) => {
  try {
    console.log("ðŸ“¥ Delegate POST received:", req.body);
    res.json({ status: "ok", taskId: req.body.taskId });
  } catch (err) {
    console.error("âŒ Error in /tasks/delegate:", err);
    res.status(500).json({ status: "error" });
  }
});

// --- 4ï¸âƒ£ Chat Endpoint for Matilda ---
app.post("/api/chat", async (req, res) => {
  try {
    const userMessage = req.body?.message || "";
    const reply = "(response placeholder)";

    // Log to dashboard ticker
    fs.appendFileSync(
      path.join(__dirname, "ui/dashboard/ticker-events.log"),
      JSON.stringify({
        timestamp: Math.floor(Date.now() / 1000),
        agent: "matilda",
        event: `chat: ${userMessage} -> ${reply}`
      }) + "\n"
    );

    res.json({ reply });
  } catch (err) {
    console.error("âŒ Error in /api/chat:", err);
    res.status(500).json({ reply: "(error)" });
  }
});

// --- 5ï¸âƒ£ Agent Status Endpoint ---
app.get("/api/agent-status", (req, res) => {
  exec("pm2 jlist", (err, stdout) => {
    if (err) {
      return res.json(statusMap);
    }

    try {
      const list = JSON.parse(stdout);
      const map = { ...statusMap };
      list.forEach(proc => {
        const name = proc.name.toLowerCase();
        const online = proc.pm2_env.status === "online";
        if (name.includes("matilda")) map.Matilda.status = online ? "online" : "offline";
        if (name.includes("cade")) map.Cade.status = online ? "online" : "offline";
        if (name.includes("effie")) map.Effie.status = online ? "online" : "offline";
      });
      res.json(map);
    } catch (err) {
      console.error("âŒ Error in /api/agent-status:", err);
      res.json(statusMap);
    }
  });
});

// --- 6ï¸âƒ£ Start Server ---
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`âœ… Dashboard live on port ${PORT}`));
