import express from "express";
import bodyParser from "body-parser";
import fs from "fs";
import path from "path";
import { exec } from "child_process";
import fetch from "node-fetch";

const app = express();
app.use(bodyParser.json());

const statusMap = { Matilda: { status: "offline" }, Cade: { status: "offline" }, Effie: { status: "offline" } };

// --- 1ï¸âƒ£ Delegate Endpoint ---
app.post("/tasks/delegate", (req, res) => {
  console.log("ðŸ“¥ Delegate POST received:", req.body);
  res.json({ status: "ok", taskId: req.body.taskId });
});

// --- 2ï¸âƒ£ Chat Endpoint ---
app.post("/api/chat", async (req, res) => {
  try {
    const userMessage = req.body?.message || "";
    const reply = "(response placeholder)";

    fs.appendFileSync(
      path.join(__dirname, "ui/dashboard/ticker-events.log"),
      JSON.stringify({ timestamp: Math.floor(Date.now()/1000), agent: "matilda", event: `chat: ${userMessage} -> ${reply}` }) + "\n"
    );

    res.json({ reply });
  } catch (err) {
    console.error("âŒ Error in /api/chat:", err);
    res.status(500).json({ reply: "(error)" });
  }
});

// --- 3ï¸âƒ£ Agent Status Endpoint ---
app.get("/api/agent-status", (req, res) => {
  exec("pm2 jlist", (err, stdout) => {
    if (err) return res.json(statusMap);

    try {
      const list = JSON.parse(stdout);
      const map = { ...statusMap };
      list.forEach(proc => {
        const name = proc.name.toLowerCase();
        const online = proc.pm2_env.status === "online";
        if (name.includes("matilda")) map.Matilda.status = online ? "online" : "offline";
        if (name.includes("cade")) map.Cade.status = online ? "online" : "offline";
        if (name.includes("effie")) map.Effie.status = online ? "online" : "offline";
      });
      res.json(map);
    } catch (err) {
      console.error("âŒ Error in /api/agent-status:", err);
      res.json(statusMap);
    }
  });
});

// --- 4ï¸âƒ£ Start Server ---
const PORT = process.env.PORT || 4000;
app.listen(PORT, () => console.log(`âœ… Dashboard live on port ${PORT}`));
